#!/usr/bin/python3
# OB - write your own commands.
#
#

import os

old =  os.getcwd()

def obopen(txt):
    try:
        for line in os.popen(txt).readlines():
            print(line.rstrip())
    except:
        pass

def main():
    obopen("bin/obclean")
    obopen("rm -fR obegg")
    obopen("mkdir obegg")
    for fn in os.listdir("obwork"):
        fnn = os.path.abspath(os.path.join(old, "obwork", fn))
        print("START %s" % fnn)
        os.chdir(fnn)
        try:
            shutil.rmtree("build")
        except:
            pass
        try:
            shutil.rmtree("dist")
        except:
            pass
        try:
            shutil.rmtree("%s.egg-info" % fn)
        except:
            pass
        for line in os.popen("python3 setup.py sdist").readlines():
            print(line.strip())
        pn = os.path.abspath(os.path.join("..", "..", "obegg"))
        obopen("cp -Ra dist/* %s" % pn)
        os.chdir(old)
    obopen("rm -fR ~/.cache/pip/")
    obopen("python3 -mvirtualenv -p python3 obenv")
    #obopen("mkdir obenv/obegg")
    #obopen("cp -Ra obegg/* obenv/obegg")
    #obopen("ls -la obenv/obegg")
    obopen("obenv/bin/pip3 install olib ob obirc obsh -f obegg --upgrade --force-reinstall")

if __name__ == "__main__":
    main()
    obopen("tar zcf obenv.tar.gz obenv")
